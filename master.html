<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Master Parcel Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    input[type="text"] {
      margin-bottom: 10px;
      padding: 4px;
      width: 300px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
    }
    thead th {
      position: sticky;
      top: 0;
      background: white;
      z-index: 1;
    }
    th, td {
      padding: 6px;
      border: 1px solid #ccc;
      text-align: left;
    }
    select.filter {
      width: 100%;
      margin-bottom: 4px;
    }
    .status-dropdown {
      width: 100%;
    }
  </style>
</head>
<body>
  <h2>Master Parcel Dashboard</h2>
  <input type="text" id="searchInput" placeholder="Search parcels..." />
  <table id="parcelTable">
    <thead>
      <tr id="filterRow"></tr>
      <tr id="headerRow"></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
      authDomain: "parcel-notes-system.firebaseapp.com",
      projectId: "parcel-notes-system",
      storageBucket: "parcel-notes-system.appspot.com",
      messagingSenderId: "538142262863",
      appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
      databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let config = {};
    let statusColors = {};
    let statusOrder = {};
    let parcels = {};
    let allData = [];

    async function loadConfig() {
      const res = await fetch("project_config.json");
      config = await res.json();
      config.statuses.forEach(s => {
        statusColors[s.name] = s.color;
        statusOrder[s.name] = s.order;
      });
    }

    async function loadGeojson() {
      const geojsonFile = await fetch("geojson_filename.txt").then(r => r.text());
      const geojsonData = await fetch(geojsonFile.trim()).then(r => r.json());
      geojsonData.features.forEach(f => {
        const uid = f.properties.uid;
        if (uid) parcels[uid] = f.properties;
      });
    }

    async function loadData() {
      const snapshot = await db.ref().once("value");
      const firebaseData = snapshot.val() || {};
      const tbody = document.querySelector("#parcelTable tbody");
      const headerRow = document.getElementById("headerRow");
      const filterRow = document.getElementById("filterRow");

      const fullColumns = config.columns.concat(["Current Status", "Last Note", "Actions"]);
      fullColumns.forEach((col, i) => {
        const th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);

        const fth = document.createElement("th");
        if (col !== "New Note" && col !== "Actions") {
          const select = document.createElement("select");
          select.className = "filter";
          select.dataset.index = i;
          select.innerHTML = `<option value="">All</option>`;
          fth.appendChild(select);
        }
        filterRow.appendChild(fth);
      });

      Object.entries(firebaseData).forEach(([uid, data]) => {
        const row = document.createElement("tr");
        const parcel = parcels[uid] || {};
        const status = data.status || "New";
        const notes = data.notes || [];
        const lastNote = notes.length > 0 ? notes[notes.length - 1].text : "";

        row.dataset.searchable = JSON.stringify({ ...parcel, ...data }).toLowerCase();
        row.className = status.replace(/ /g, "_");
        if (statusColors[status]) row.style.backgroundColor = statusColors[status];

        config.columns.forEach(col => {
          const td = document.createElement("td");
          td.textContent = data[col] ?? parcel[col] ?? "";
          row.appendChild(td);
        });

        const statusTd = document.createElement("td");
        const select = document.createElement("select");
        select.className = "status-dropdown";
        config.statuses.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.name;
          opt.textContent = s.name;
          if (s.name === status) opt.selected = true;
          select.appendChild(opt);
        });
        statusTd.appendChild(select);
        row.appendChild(statusTd);

        const noteTd = document.createElement("td");
        noteTd.textContent = lastNote;
        row.appendChild(noteTd);

        const actionTd = document.createElement("td");
        actionTd.innerHTML = `
          <a href="notes.html?uid=${uid}" target="_blank">üìù Notes</a> |
          <a href="index.html?uid=${uid}" target="_blank">üó∫Ô∏è Map</a>`;
        row.appendChild(actionTd);

        allData.push({ uid, row, statusOrder: statusOrder[status] || 999 });

        select.onchange = () => {
          db.ref(uid).update({ status: select.value }).then(() => {
            row.style.backgroundColor = statusColors[select.value] || "";
            row.className = select.value.replace(/ /g, "_");
            alert("Status updated.");
          });
        };
      });

      // Populate filters
      fullColumns.forEach((col, i) => {
        const values = new Set();
        allData.forEach(obj => {
          const cell = obj.row.children[i];
          if (cell) values.add(cell.textContent.trim());
        });
        const select = filterRow.children[i]?.querySelector("select");
        if (select) {
          [...values].sort().forEach(val => {
            const option = document.createElement("option");
            option.value = val;
            option.textContent = val;
            select.appendChild(option);
          });
        }
      });

      allData.sort((a, b) => a.statusOrder - b.statusOrder);
      allData.forEach(obj => tbody.appendChild(obj.row));
    }

    async function init() {
      await loadConfig();
      await loadGeojson();
      await loadData();
    }

    init();

    // Search with debounce
    let searchTimeout = null;
    document.getElementById("searchInput").addEventListener("input", e => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const val = e.target.value.toLowerCase();
        document.querySelectorAll("#parcelTable tbody tr").forEach(tr => {
          tr.style.display = tr.dataset.searchable.includes(val) ? "" : "none";
        });
      }, 300);
    });

    // Filter logic
    document.getElementById("filterRow").addEventListener("change", () => {
      const filters = [...document.querySelectorAll("select.filter")].map(s => s.value);
      document.querySelectorAll("#parcelTable tbody tr").forEach(tr => {
        const tds = tr.children;
        let visible = true;
        filters.forEach((val, i) => {
          if (val && !tds[i].textContent.includes(val)) visible = false;
        });
        tr.style.display = visible ? "" : "none";
      });
    });
  </script>
</body>
</html>
