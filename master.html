<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Master Parcel Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; margin: 0; padding: 1rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; font-size: 14px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; }
    th { background: #f5f5f5; position: sticky; top: 0; z-index: 2; }
    tr:hover { background-color: #f1f1f1; }
    input[type="text"] { padding: 6px; width: 300px; margin-bottom: 10px; }
    select, textarea { width: 100%; font-size: 14px; }
    #summary { margin-bottom: 0.5rem; font-weight: bold; }
  </style>
</head>
<body>
<h2>ðŸ“‹ Master Parcel Dashboard</h2>
<div id="summary"></div>
<input type="text" id="searchBox" placeholder="Search within filtered rows..." />
<div id="tableContainer">Loading...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-app.js";
import { getDatabase, ref, update, child, get } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-database.js";
import { firebaseConfig } from './firebase-config.js';

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const geojsonFile = "geojson_filename.txt";
const configFile = "project_config.json";
let allRows = [], tableColumns = [], statusOrder = {}, statusColors = {}, lastSearch = "";

const loadConfig = async () => {
  const config = await fetch(configFile).then(r => r.json());
  config.statuses.forEach(s => {
    statusOrder[s.name.toLowerCase()] = s.order;
    statusColors[s.name] = s.color;
  });
  return config;
};

const fetchGeoJSON = async () => {
  const filename = await fetch(geojsonFile).then(res => res.text());
  return fetch(filename.trim()).then(res => res.json());
};

function updateSummary() {
  const rows = Array.from(document.querySelectorAll("tbody tr")).filter(r => r.style.display !== "none");
  const total = rows.length;
  const interested = rows.filter(r => {
    const status = r.querySelector("select.status")?.value?.toLowerCase();
    return status && statusOrder[status] <= 5;
  }).length;
  const pct = total ? Math.round((interested / total) * 100) : 0;
  document.getElementById("summary").textContent = `ðŸš€ ${pct}% Interested (${interested} of ${total} visible parcels)`;
}

function sortTableBody() {
  const tbody = document.querySelector("tbody");
  const rows = Array.from(tbody.querySelectorAll("tr")).filter(r => r.style.display !== "none");
  rows.sort((a, b) => {
    const sa = a.querySelector("select.status")?.value?.toLowerCase() || "z";
    const sb = b.querySelector("select.status")?.value?.toLowerCase() || "z";
    return (statusOrder[sa] || 99) - (statusOrder[sb] || 99);
  });
  rows.forEach(row => tbody.appendChild(row));
}

function applyFilters() {
  const terms = {};
  document.querySelectorAll(".filter").forEach(sel => {
    const col = sel.dataset.col;
    const val = sel.value;
    if (val) terms[col] = val;
  });

  document.querySelectorAll("tbody tr").forEach(row => {
    const cells = row.querySelectorAll("td");
    let visible = true;
    for (const key in terms) {
      const idx = tableColumns.indexOf(key);
      if (!row.cells[idx] || !row.cells[idx].textContent.includes(terms[key])) visible = false;
    }
    row.style.display = visible ? "" : "none";
  });

  searchFilter();
  sortTableBody();
  updateSummary();
}

let debounceTimer;
function searchFilter() {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    const term = document.getElementById("searchBox").value.toLowerCase();
    lastSearch = term;
    document.querySelectorAll("tbody tr").forEach(row => {
      if (row.style.display === "none") return;
      row.style.display = Array.from(row.cells).some(td => td.innerText.toLowerCase().includes(term)) ? "" : "none";
    });
    sortTableBody();
    updateSummary();
  }, 250);
}

document.getElementById("searchBox").addEventListener("input", searchFilter);

function renderTable(uids, parcels, fbData, config) {
  const container = document.getElementById("tableContainer");
  tableColumns = ["uid", ...config.columns.filter(c => c !== "uid"), "Status", "New Note", "Save", "View Parcel", "Notes Page"];

  const dropdowns = tableColumns.map(col => {
    if (["New Note", "Save", "Notes Page", "View Parcel"].includes(col)) return `<th>${col}</th>`;
    const values = [...new Set(uids.map(uid => parcels[uid]?.[col]).filter(Boolean))].sort();
    return `<th>
      <select data-col="${col}" class="filter">
        <option value="">All ${col}</option>
        ${values.map(v => `<option>${v}</option>`).join("")}
      </select>
    </th>`;
  }).join("");

  let html = `<table><thead><tr>${dropdowns}</tr><tr>${tableColumns.map(c => `<th>${c}</th>`).join("")}</tr></thead><tbody>`;

  const rows = uids.map(uid => {
    const parcel = parcels[uid] || {};
    const fb = fbData[uid] || {};
    const status = fb.status || parcel.Status || "New";
    const notes = fb.notes || [];
    const rowClass = statusColors[status] ? `style="background:${statusColors[status]}"` : "";

    let rowHtml = `<tr ${rowClass} data-uid="${uid}">`;

    tableColumns.forEach(col => {
      if (col === "Status") {
        rowHtml += `<td>
          <select class="status" data-uid="${uid}">
            ${config.statuses.map(s => `<option value="${s.name}" ${s.name === status ? "selected" : ""}>${s.name}</option>`).join("")}
          </select>
        </td>`;
      } else if (col === "New Note") {
        rowHtml += `<td><textarea rows="2" class="note" data-uid="${uid}"></textarea></td>`;
      } else if (col === "Save") {
        rowHtml += `<td><button data-uid="${uid}" class="save">ðŸ’¾</button></td>`;
      } else if (col === "View Parcel") {
        rowHtml += `<td><a href="index.html?uid=${uid}" target="_blank">View</a></td>`;
      } else if (col === "Notes Page") {
        rowHtml += `<td><a href="notes.html?uid=${uid}" target="_blank">ðŸ“‹ Notes</a></td>`;
      } else {
        rowHtml += `<td>${(parcel[col] ?? fb[col]) || ""}</td>`;
      }
    });

    rowHtml += `</tr>`;
    return { html: rowHtml, order: statusOrder[status.toLowerCase()] || 99 };
  });

  rows.sort((a, b) => a.order - b.order).forEach(r => html += r.html);
  html += `</tbody></table>`;
  container.innerHTML = html;

  document.querySelectorAll(".save").forEach(btn => {
    btn.addEventListener("click", async () => {
      const uid = btn.dataset.uid;
      const noteEl = document.querySelector(`textarea.note[data-uid='${uid}']`);
      const statusEl = document.querySelector(`select.status[data-uid='${uid}']`);
      const newNote = noteEl.value.trim();
      const newStatus = statusEl.value;

      const snap = await get(child(ref(db), `${uid}/notes`));
      const notes = snap.exists() ? Object.values(snap.val()) : [];
      if (newNote) {
        notes.push({ text: newNote, user: "Ben", timestamp: new Date().toISOString() });
      }

      await update(ref(db, uid), { status: newStatus, notes });
      await refreshTable();
    });
  });

  document.querySelectorAll(".filter").forEach(drop => {
    drop.addEventListener("change", () => {
      applyFilters();
    });
  });

  updateSummary();
}

async function refreshTable() {
  const [config, geojson, snapshot] = await Promise.all([
    loadConfig(),
    fetchGeoJSON(),
    get(ref(db))
  ]);
  const parcels = {};
  const uids = [];
  geojson.features.forEach(f => {
    const uid = f.properties.uid;
    if (uid) {
      uids.push(uid);
      parcels[uid] = f.properties;
    }
  });
  renderTable(uids, parcels, snapshot.val() || {}, config);
  document.getElementById("searchBox").value = lastSearch;
  applyFilters();
  searchFilter();
}

Promise.all([loadConfig(), fetchGeoJSON(), get(ref(db))]).then(([config, geojson, snapshot]) => {
  const parcels = {};
  const uids = [];
  geojson.features.forEach(f => {
    const uid = f.properties.uid;
    if (uid) {
      uids.push(uid);
      parcels[uid] = f.properties;
    }
  });
  renderTable(uids, parcels, snapshot.val() || {}, config);
});
</script>
</body>
</html>
