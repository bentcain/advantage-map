<!DOCTYPE html>
<html>
<head>
  <title>Parcel Master Spreadsheet</title>
  <meta charset="utf-8" />
  <style>
    table { width: 100%; border-collapse: collapse; }
    td, th { border: 1px solid #ccc; padding: 5px; font-size: 12px; }
    th { background: #f0f0f0; }
    textarea { width: 100%; }
    select { width: 100%; }
  </style>
</head>
<body>
  <h2>ðŸ“Š Parcel Master Spreadsheet</h2>
  <p>This dashboard shows all parcels, notes, status, and allows full table interaction.</p>
  <div id="table-container">Loading...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
      authDomain: "parcel-notes-system.firebaseapp.com",
      projectId: "parcel-notes-system",
      storageBucket: "parcel-notes-system.appspot.com",
      messagingSenderId: "538142262863",
      appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
      measurementId: "G-GQ3CQ9EKPH",
      databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const uidMap = await fetch('uid_map.json').then(r => r.json());
    const geojsonFile = await fetch('geojson_filename.txt').then(r => r.text());
    const geojson = await fetch(geojsonFile.trim()).then(r => r.json());

    const container = document.getElementById("table-container");
    const table = document.createElement("table");
    const headerRow = document.createElement("tr");

    const allKeys = new Set();
    geojson.features.forEach(f => Object.keys(f.properties).forEach(k => allKeys.add(k)));
    const dynamicFields = Array.from(allKeys);

    const headers = [...dynamicFields, "UID", "Status", "New Note", "Submit", "Note History", "Actions"];
    headers.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      headerRow.appendChild(th);
    });
    table.appendChild(headerRow);

    geojson.features.forEach(feature => {
      const row = document.createElement("tr");
      const uid = feature.properties.uid || "";
      const firebasePath = `parcel_${uid}`;

      // Dynamic property columns
      dynamicFields.forEach(key => {
        const td = document.createElement("td");
        td.textContent = feature.properties[key] || "";
        row.appendChild(td);
      });

      // UID cell
      const uidCell = document.createElement("td");
      uidCell.textContent = firebasePath;
      row.appendChild(uidCell);

      // Status dropdown
      const statusCell = document.createElement("td");
      const dropdown = document.createElement("select");
      const statusOptions = [
        "New", "New with Contact",
        "Follow Up 1", "Follow Up 2", "Follow Up 3",
        "On Hold", "Not Interested", "Conversion"
      ];
      statusOptions.forEach(opt => {
        const option = new Option(opt, opt);
        dropdown.add(option);
      });
      statusCell.appendChild(dropdown);
      row.appendChild(statusCell);

      // Note input
      const noteCell = document.createElement("td");
      const noteBox = document.createElement("textarea");
      noteBox.rows = 2;
      noteCell.appendChild(noteBox);
      row.appendChild(noteCell);

      // Submit button
      const submitCell = document.createElement("td");
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Save";
      saveBtn.onclick = () => {
        const noteText = noteBox.value.trim();
        const newStatus = dropdown.value;
        if (!noteText && !newStatus) return;

        if (noteText) {
          push(ref(db, `${firebasePath}/notes`), {
            text: noteText,
            timestamp: new Date().toISOString(),
            status: newStatus,
            source: "master"
          });
        }

        if (newStatus) {
          update(ref(db), { [`${firebasePath}/status`]: newStatus });
        }

        noteBox.value = "";
        alert("Saved!");
      };
      submitCell.appendChild(saveBtn);
      row.appendChild(submitCell);

      // Note history
      const historyCell = document.createElement("td");
      row.appendChild(historyCell);

      // Actions (Zoom & Notes View)
      const actionCell = document.createElement("td");
      actionCell.innerHTML = `
        <button onclick="window.open('index.html?highlight=${uidMap[uid]}', '_blank')">Zoom to Parcel</button>
        <button onclick="window.open('notes.html?uid=parcel_${uid}', '_blank')">View Parcel Notes</button>
      `;
      row.appendChild(actionCell);

      table.appendChild(row);

      // Firebase Sync
      onValue(ref(db, firebasePath), (snapshot) => {
        const data = snapshot.val() || {};
        const currentStatus = data.status || "";
        if (statusOptions.includes(currentStatus)) dropdown.value = currentStatus;

        const notes = data.notes || {};
        const entries = Object.values(notes).sort((a, b) =>
          (b.timestamp || "").localeCompare(a.timestamp || "")
        );

        let history = "";
        entries.forEach(note => {
          history += `<b>${note.status}</b>: ${note.text}<br><small>${note.timestamp}</small><br><br>`;
        });
        historyCell.innerHTML = history || "â€”";
      });
    });

    container.innerHTML = "";
    container.appendChild(table);
  </script>
</body>
</html>
