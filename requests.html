<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Request Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
    }
    textarea {
      width: 95%;
      margin-top: 5px;
    }
    .closed {
      opacity: 0.6;
    }
    .view-link {
      text-decoration: none;
      color: blue;
    }
    .save-btn, .close-btn {
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h2>Request Dashboard</h2>
  <table id="requestTable">
    <thead>
      <tr>
        <th>Parcel UID</th>
        <th>Request</th>
        <th>Assigned To</th>
        <th>Created By</th>
        <th>Status</th>
        <th>Created</th>
        <th>Comments</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
      authDomain: "parcel-notes-system.firebaseapp.com",
      projectId: "parcel-notes-system",
      storageBucket: "parcel-notes-system.appspot.com",
      messagingSenderId: "538142262863",
      appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
      measurementId: "G-GQ3CQ9EKPH",
      databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const currentUser = localStorage.getItem("username") || "Ben";

    const table = document.getElementById("requestTable").querySelector("tbody");

    function renderRow(uid, requestId, request) {
      const row = document.createElement("tr");
      if (request.status === "closed") row.classList.add("closed");

      const uidCell = document.createElement("td");
      uidCell.innerHTML = `<a class="view-link" href="notes.html?uid=${uid}" target="_blank">${uid}</a>`;
      row.appendChild(uidCell);

      const textCell = document.createElement("td");
      textCell.textContent = request.text;
      row.appendChild(textCell);

      const assignedCell = document.createElement("td");
      assignedCell.textContent = request.assignedTo;
      row.appendChild(assignedCell);

      const createdByCell = document.createElement("td");
      createdByCell.textContent = request.createdBy;
      row.appendChild(createdByCell);

      const statusCell = document.createElement("td");
      statusCell.textContent = request.status;
      row.appendChild(statusCell);

      const dateCell = document.createElement("td");
      dateCell.textContent = new Date(request.createdAt).toLocaleString();
      row.appendChild(dateCell);

      const commentsCell = document.createElement("td");
      const comments = request.comments || [];
      commentsCell.innerHTML = comments.map(c =>
        `<div><strong>${c.user}</strong>: ${c.text} <br><small>${new Date(c.timestamp).toLocaleString()}</small></div><hr>`
      ).join("");

      const replyBox = document.createElement("textarea");
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Reply";
      saveBtn.className = "save-btn";
      saveBtn.onclick = () => {
        const reply = replyBox.value.trim();
        if (!reply) return;
        const newComment = {
          text: reply,
          user: currentUser,
          timestamp: new Date().toISOString()
        };
        const updatedComments = [...comments, newComment];
        db.ref(`requests/${uid}/${requestId}`).update({ comments: updatedComments });
        alert("Reply added.");
        location.reload();
      };

      const closeBtn = document.createElement("button");
      closeBtn.textContent = "Close Request";
      closeBtn.className = "close-btn";
      closeBtn.onclick = () => {
        db.ref(`requests/${uid}/${requestId}`).update({
          status: "closed",
          closedAt: new Date().toISOString()
        });
        alert("Request marked as closed.");
        location.reload();
      };

      commentsCell.appendChild(replyBox);
      commentsCell.appendChild(saveBtn);
      if (request.status !== "closed") {
        commentsCell.appendChild(closeBtn);
      }

      row.appendChild(commentsCell);

      const actionsCell = document.createElement("td");
      actionsCell.innerHTML = `<a href="notes.html?uid=${uid}" target="_blank">View Notes</a>`;
      row.appendChild(actionsCell);

      table.appendChild(row);
    }

    function loadRequests() {
      db.ref("requests").once("value").then(snapshot => {
        const allRequests = snapshot.val() || {};
        const openRequests = [];
        const closedRequests = [];

        Object.entries(allRequests).forEach(([uid, requests]) => {
          Object.entries(requests).forEach(([requestId, request]) => {
            if (request.status === "closed") {
              closedRequests.push({ uid, requestId, request });
            } else {
              openRequests.push({ uid, requestId, request });
            }
          });
        });

        // Sort
        openRequests.sort((a, b) => new Date(a.request.createdAt) - new Date(b.request.createdAt));
        closedRequests.sort((a, b) => new Date(b.request.closedAt || 0) - new Date(a.request.closedAt || 0));

        [...openRequests, ...closedRequests].forEach(({ uid, requestId, request }) =>
          renderRow(uid, requestId, request)
        );
      });
    }

    loadRequests();
  </script>
</body>
</html>
