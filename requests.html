<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Request Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
    }
    textarea {
      width: 95%;
      margin-top: 5px;
    }
    select {
      margin-bottom: 10px;
    }
    .New { background-color: #ffffff; }
    .Follow\ Up { background-color: #ffe699; }
    .On\ Hold { background-color: #d9d9d9; }
    .Conversion { background-color: #c6efce; }
    .Not\ Interested { background-color: #f4cccc; }
    .closed { opacity: 0.6; }
  </style>
</head>
<body>
  <h2>Request Dashboard</h2>

  <label>Filter by Assigned To:
    <select id="assignedFilter">
      <option value="">All</option>
    </select>
  </label>
  <label>Filter by Lead Status:
    <select id="leadFilter">
      <option value="">All</option>
    </select>
  </label>

  <table id="requestTable">
    <thead>
      <tr>
        <th>Parcel UID</th>
        <th>Request</th>
        <th>Assigned To</th>
        <th>Created By</th>
        <th>Request State</th>
        <th>Lead Status</th>
        <th>Created</th>
        <th>Comments</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
      authDomain: "parcel-notes-system.firebaseapp.com",
      projectId: "parcel-notes-system",
      storageBucket: "parcel-notes-system.appspot.com",
      messagingSenderId: "538142262863",
      appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
      measurementId: "G-GQ3CQ9EKPH",
      databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const currentUser = localStorage.getItem("username") || "Ben";

    const assignedFilter = document.getElementById("assignedFilter");
    const leadFilter = document.getElementById("leadFilter");
    const tableBody = document.getElementById("requestTable").querySelector("tbody");

    let allRequests = [];

    function applyFilters() {
      tableBody.innerHTML = "";
      const assignedVal = assignedFilter.value;
      const leadVal = leadFilter.value;

      let filtered = allRequests;
      if (assignedVal) filtered = filtered.filter(r => r.request.assignedTo === assignedVal);
      if (leadVal) filtered = filtered.filter(r => r.leadStatus === leadVal);

      filtered.forEach(renderRow);
    }

    function renderRow({ uid, requestId, request, leadStatus }) {
      const row = document.createElement("tr");
      row.classList.add(leadStatus?.replace(/ /g, "_") || "");
      if (request.status === "closed") row.classList.add("closed");

      row.innerHTML = `
        <td><a href="notes.html?uid=${uid}" target="_blank">${uid}</a></td>
        <td>${request.text}</td>
        <td>${request.assignedTo}</td>
        <td>${request.createdBy}</td>
        <td>${request.status}</td>
        <td>${leadStatus || "â€”"}</td>
        <td>${new Date(request.createdAt).toLocaleString()}</td>
      `;

      const commentsCell = document.createElement("td");
      const comments = request.comments || [];
      commentsCell.innerHTML = comments.map(c =>
        `<div><strong>${c.user}</strong>: ${c.text}<br><small>${new Date(c.timestamp).toLocaleString()}</small></div><hr>`
      ).join("");

      const replyBox = document.createElement("textarea");
      const replyBtn = document.createElement("button");
      replyBtn.textContent = "Reply";
      replyBtn.onclick = () => {
        const reply = replyBox.value.trim();
        if (!reply) return;
        const comment = {
          text: reply,
          user: currentUser,
          timestamp: new Date().toISOString()
        };
        const updatedComments = [...comments, comment];
        db.ref(`requests/${uid}/${requestId}`).update({ comments: updatedComments }).then(() => {
          alert("Reply added.");
          location.reload();
        });
      };

      const closeBtn = document.createElement("button");
      closeBtn.textContent = "Close Request";
      closeBtn.onclick = () => {
        db.ref(`requests/${uid}/${requestId}`).update({
          status: "closed",
          closedAt: new Date().toISOString()
        }).then(() => {
          alert("Request closed.");
          location.reload();
        });
      };

      commentsCell.appendChild(replyBox);
      commentsCell.appendChild(replyBtn);
      if (request.status !== "closed") commentsCell.appendChild(closeBtn);
      row.appendChild(commentsCell);

      const actionsCell = document.createElement("td");
      actionsCell.innerHTML = `<a href="notes.html?uid=${uid}" target="_blank">View Notes</a>`;
      row.appendChild(actionsCell);

      tableBody.appendChild(row);
    }

    function loadRequests() {
      Promise.all([
        db.ref("requests").once("value"),
        db.ref().once("value")
      ]).then(([requestsSnap, geoSnap]) => {
        const requests = requestsSnap.val() || {};
        const parcels = geoSnap.val() || {};

        const open = [], closed = [];
        const assignedUsers = new Set();
        const leadStatuses = new Set();

        Object.entries(requests).forEach(([uid, reqs]) => {
          Object.entries(reqs).forEach(([requestId, request]) => {
            const leadStatus = parcels[uid]?.status || "";
            assignedUsers.add(request.assignedTo);
            if (leadStatus) leadStatuses.add(leadStatus);

            const entry = { uid, requestId, request, leadStatus };
            if (request.status === "closed") closed.push(entry);
            else open.push(entry);
          });
        });

        open.sort((a, b) => new Date(a.request.createdAt) - new Date(b.request.createdAt));
        closed.sort((a, b) => new Date(b.request.closedAt || 0) - new Date(a.request.closedAt || 0));
        allRequests = [...open, ...closed];

        assignedUsers.forEach(user => {
          const opt = document.createElement("option");
          opt.value = user;
          opt.textContent = user;
          assignedFilter.appendChild(opt);
        });

        leadStatuses.forEach(status => {
          const opt = document.createElement("option");
          opt.value = status;
          opt.textContent = status;
          leadFilter.appendChild(opt);
        });

        applyFilters();
      });
    }

    assignedFilter.onchange = leadFilter.onchange = applyFilters;
    loadRequests();
  </script>
</body>
</html>
