<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Request Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; vertical-align: top; }
    input, select, textarea { font-size: 14px; }
    textarea { width: 100%; resize: vertical; }
    .filter { width: 100%; }
  </style>
</head>
<body>
  <h2>Request Dashboard</h2>
  <input type="text" id="searchInput" placeholder="Search..." style="width:300px;" />
  <table id="requestTable">
    <thead>
      <tr id="filterRow"></tr>
      <tr>
        <th>Parcel UID</th>
        <th>Request</th>
        <th>Assigned To</th>
        <th>Created By</th>
        <th>Request State</th>
        <th>Status</th>
        <th>Created</th>
        <th>Comments</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-app.js";
    import { getDatabase, ref, child, get, update } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-database.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const currentUser = localStorage.getItem("username") || "Ben";

    let config = {}, statusColors = {}, statusOrder = {}, parcels = {}, fbData = {};
    const tbody = document.querySelector("#requestTable tbody");
    const filterRow = document.getElementById("filterRow");

    async function loadConfig() {
      const res = await fetch("project_config.json");
      config = await res.json();
      config.statuses.forEach(s => {
        statusColors[s.name] = s.color;
        statusOrder[s.name.toLowerCase()] = s.order;
      });
    }

    async function loadGeojson() {
      const file = await fetch("geojson_filename.txt").then(r => r.text());
      const data = await fetch(file.trim()).then(r => r.json());
      data.features.forEach(f => {
        const uid = f.properties.uid;
        if (uid) parcels[uid] = f.properties;
      });
    }

    async function loadFirebase() {
      const snapshot = await get(ref(db));
      fbData = snapshot.val() || {};
    }

    function buildFilters(columns) {
      filterRow.innerHTML = "";
      columns.forEach((col, idx) => {
        const th = document.createElement("th");
        if (["Request", "Created"].includes(col)) return filterRow.appendChild(th);
        const sel = document.createElement("select");
        sel.innerHTML = `<option value="">All</option>`;
        sel.className = "filter";
        sel.dataset.col = col;
        th.appendChild(sel);
        filterRow.appendChild(th);
      });
    }

    function populateTable(requests) {
      tbody.innerHTML = "";
      const columns = ["Parcel UID", "Request", "Assigned To", "Created By", "Request State", "Status", "Created", "Comments", "Actions"];
      buildFilters(columns);

      requests.forEach(r => {
        const tr = document.createElement("tr");
        tr.dataset.searchable = Object.values(r).join(" ").toLowerCase();
        tr.style.backgroundColor = statusColors[r.status] || "";

        tr.innerHTML = `
          <td>${r.uid}</td>
          <td>${r.text}</td>
          <td>${r.assignedTo}</td>
          <td>${r.createdBy}</td>
          <td>${r.reqStatus}</td>
          <td>${r.status}</td>
          <td>${new Date(r.createdAt).toLocaleString()}</td>
          <td>
            ${r.comments.map(c => `<div><strong>${c.user || "?"}</strong>: ${c.text}<br><small>${c.timestamp || ""}</small></div>`).join("<hr>")}
            <textarea rows="2"></textarea><br>
            <button class="reply">Reply</button>
            ${r.reqStatus === "open" ? `<button class="close">Close Request</button>` : ""}
          </td>
          <td><a href="notes.html?uid=${r.uid}" target="_blank">View Notes</a></td>
        `;

        tr.querySelector(".reply").onclick = () => {
          const txt = tr.querySelector("textarea").value.trim();
          if (!txt) return;
          const comment = { text: txt, user: currentUser, timestamp: new Date().toISOString() };
          const commentPath = `requests/${r.uid}/${r.id}/comments`;
          const commentRef = child(ref(db), commentPath);
          get(commentRef).then(snapshot => {
            const comments = snapshot.val() || [];
            comments.push(comment);
            update(ref(db, `requests/${r.uid}/${r.id}`), { comments }).then(() => location.reload());
          });
        };

        if (tr.querySelector(".close")) {
          tr.querySelector(".close").onclick = () => {
            update(ref(db, `requests/${r.uid}/${r.id}`), { status: "closed" }).then(() => location.reload());
          };
        }

        tbody.appendChild(tr);
      });

      document.querySelectorAll("select.filter").forEach(sel => {
        const col = sel.dataset.col;
        const idx = columns.indexOf(col);
        const values = new Set();
        requests.forEach(r => values.add(r[col.toLowerCase().replace(" ", "")]));
        [...values].sort().forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", applyFilters);
      });
    }

    function applyFilters() {
      const terms = {};
      document.querySelectorAll("select.filter").forEach(sel => {
        if (sel.value) terms[sel.dataset.col] = sel.value;
      });
      [...tbody.rows].forEach(tr => {
        const visible = Object.entries(terms).every(([col, val]) => {
          const idx = [...tr.parentElement.rows[1].cells].findIndex(c => c.textContent.trim() === col);
          return tr.cells[idx]?.textContent.includes(val);
        });
        tr.style.display = visible ? "" : "none";
      });
    }

    document.getElementById("searchInput").addEventListener("input", () => {
      const term = document.getElementById("searchInput").value.toLowerCase();
      [...tbody.rows].forEach(tr => {
        tr.style.display = tr.dataset.searchable.includes(term) ? "" : "none";
      });
    });

    async function loadRequests() {
      const all = [];
      for (const uid in fbData.requests || {}) {
        const reqs = fbData.requests[uid];
        for (const id in reqs) {
          const r = reqs[id];
          const status = fbData[uid]?.status || parcels[uid]?.Status || "New";
          all.push({
            id,
            uid,
            text: r.text || "",
            assignedTo: r.assignedTo || "",
            createdBy: r.createdBy || "",
            reqStatus: r.status || "open",
            status,
            createdAt: r.createdAt || "",
            comments: r.comments || []
          });
        }
      }

      const open = all.filter(r => r.reqStatus === "open");
      const closed = all.filter(r => r.reqStatus === "closed");

      open.sort((a, b) => (statusOrder[a.status.toLowerCase()] || 99) - (statusOrder[b.status.toLowerCase()] || 99));
      closed.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      populateTable([...open, ...closed]);
    }

    await loadConfig();
    await loadGeojson();
    await loadFirebase();
    await loadRequests();
  </script>
</body>
</html>
