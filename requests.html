<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Request Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
    }
    textarea {
      width: 95%;
      margin-top: 5px;
    }
    select.filter {
      width: 100%;
      margin-bottom: 4px;
    }
    .New { background-color: #ffffff; }
    .Follow_Up { background-color: #ffe699; }
    .On_Hold { background-color: #d9d9d9; }
    .Conversion { background-color: #c6efce; }
    .Not_Interested { background-color: #f4cccc; }
    .closed { opacity: 0.6; }
  </style>
</head>
<body>
  <h2>Request Dashboard</h2>
  <table id="requestTable">
    <thead>
      <tr id="filterRow"></tr>
      <tr>
        <th>Parcel UID</th>
        <th>Request</th>
        <th>Assigned To</th>
        <th>Created By</th>
        <th>Request State</th>
        <th>Lead Status</th>
        <th>Created</th>
        <th>Comments</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
      authDomain: "parcel-notes-system.firebaseapp.com",
      projectId: "parcel-notes-system",
      storageBucket: "parcel-notes-system.appspot.com",
      messagingSenderId: "538142262863",
      appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
      measurementId: "G-GQ3CQ9EKPH",
      databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const currentUser = localStorage.getItem("username") || "Ben";

    const columns = ["uid", "text", "assignedTo", "createdBy", "status", "leadStatus", "created", "", ""]; // for filtering
    let allRequests = [];

    function createFilterRow(data) {
      const filterRow = document.getElementById("filterRow");
      filterRow.innerHTML = "";

      columns.forEach((col, index) => {
        const th = document.createElement("th");
        if (col && col !== "created") {
          const select = document.createElement("select");
          select.className = "filter";
          select.dataset.column = index;
          const uniqueValues = Array.from(new Set(data.map(row => row[col] || ""))).sort();
          select.innerHTML = `<option value="">All</option>` + uniqueValues.map(v => `<option>${v}</option>`).join("");
          select.onchange = filterTable;
          th.appendChild(select);
        }
        filterRow.appendChild(th);
      });
    }

    function filterTable() {
      const filters = Array.from(document.querySelectorAll("select.filter")).map(s => s.value);
      const rows = document.querySelectorAll("#requestTable tbody tr");

      rows.forEach(row => {
        let show = true;
        filters.forEach((val, i) => {
          if (val && !row.children[i].innerText.includes(val)) {
            show = false;
          }
        });
        row.style.display = show ? "" : "none";
      });
    }

    function renderRow({ uid, requestId, request, leadStatus }) {
      const row = document.createElement("tr");
      const safeStatus = (leadStatus || "").replace(/ /g, "_");
      if (safeStatus) row.classList.add(safeStatus);
      if (request.status === "closed") row.classList.add("closed");

      row.innerHTML = `
        <td>${uid}</td>
        <td>${request.text}</td>
        <td>${request.assignedTo}</td>
        <td>${request.createdBy}</td>
        <td>${request.status}</td>
        <td>${leadStatus || "â€”"}</td>
        <td>${new Date(request.createdAt).toLocaleString()}</td>
      `;

      const commentsCell = document.createElement("td");
      const comments = request.comments || [];
      commentsCell.innerHTML = comments.map(c =>
        `<div><strong>${c.user}</strong>: ${c.text}<br><small>${new Date(c.timestamp).toLocaleString()}</small></div><hr>`
      ).join("");

      const replyBox = document.createElement("textarea");
      const replyBtn = document.createElement("button");
      replyBtn.textContent = "Reply";
      replyBtn.onclick = () => {
        const reply = replyBox.value.trim();
        if (!reply) return;
        const comment = {
          text: reply,
          user: currentUser,
          timestamp: new Date().toISOString()
        };
        const updatedComments = [...comments, comment];
        db.ref(`requests/${uid}/${requestId}`).update({ comments: updatedComments }).then(() => {
          alert("Reply added.");
          location.reload();
        });
      };

      const closeBtn = document.createElement("button");
      closeBtn.textContent = "Close Request";
      closeBtn.onclick = () => {
        db.ref(`requests/${uid}/${requestId}`).update({
          status: "closed",
          closedAt: new Date().toISOString()
        }).then(() => {
          alert("Request closed.");
          location.reload();
        });
      };

      commentsCell.appendChild(replyBox);
      commentsCell.appendChild(replyBtn);
      if (request.status !== "closed") commentsCell.appendChild(closeBtn);
      row.appendChild(commentsCell);

      const actionsCell = document.createElement("td");
      actionsCell.innerHTML = `<a href="notes.html?uid=${uid}" target="_blank">View Notes</a>`;
      row.appendChild(actionsCell);

      document.querySelector("#requestTable tbody").appendChild(row);
    }

    function loadRequests() {
      Promise.all([
        db.ref("requests").once("value"),
        db.ref().once("value")
      ]).then(([requestsSnap, geoSnap]) => {
        const requests = requestsSnap.val() || {};
        const parcels = geoSnap.val() || {};

        const open = [], closed = [];

        Object.entries(requests).forEach(([uid, reqs]) => {
          Object.entries(reqs).forEach(([requestId, request]) => {
            const leadStatus = parcels[uid]?.status || "";
            const entry = {
              uid,
              requestId,
              request,
              leadStatus,
              text: request.text,
              assignedTo: request.assignedTo,
              createdBy: request.createdBy,
              status: request.status,
              created: new Date(request.createdAt).toLocaleString()
            };
            if (request.status === "closed") closed.push(entry);
            else open.push(entry);
          });
        });

        open.sort((a, b) => new Date(a.request.createdAt) - new Date(b.request.createdAt));
        closed.sort((a, b) => new Date(b.request.closedAt || 0) - new Date(a.request.closedAt || 0));
        allRequests = [...open, ...closed];

        createFilterRow(allRequests);
        allRequests.forEach(renderRow);
      });
    }

    loadRequests();
  </script>
</body>
</html>
