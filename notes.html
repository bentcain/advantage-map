<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parcel Notes Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; vertical-align: top; }
    input, select, textarea { font-size: 14px; width: 100%; }
    textarea { resize: vertical; }
    .request-tag { font-weight: bold; color: red; }
    .reply-box { margin-top: 5px; }
  </style>
</head>
<body>
  <h2>Parcel Notes Dashboard</h2>
  <input type="text" id="searchInput" placeholder="Search..." />
  Request Filter:
  <select id="requestFilter">
    <option value="all">All Notes</option>
    <option value="open">Open Requests</option>
    <option value="closed">Closed Requests</option>
  </select>
  <table id="notesTable">
    <thead><tr id="headerRow"></tr></thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-app.js";
    import { getDatabase, ref, get, update, child } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-database.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const currentUser = localStorage.getItem("username") || "Ben";
    const uidParam = new URLSearchParams(window.location.search).get("uid");

    let config = {}, parcels = {}, fbData = {}, allRows = [];

    async function loadConfig() {
      const res = await fetch("project_config.json");
      config = await res.json();
    }

    async function loadParcels() {
      const file = await fetch("geojson_filename.txt").then(r => r.text());
      const geojson = await fetch(file.trim()).then(r => r.json());
      geojson.features.forEach(f => {
        const uid = f.properties.uid;
        parcels[uid] = f.properties;
      });
    }

    async function loadFirebase() {
      const snapshot = await get(ref(db));
      fbData = snapshot.val() || {};
    }

    function buildTable() {
      const columns = ["uid", ...config.columns.slice(1, 3), "Status", "New Note", "Save", "Note History"];
      const headerRow = document.getElementById("headerRow");
      const tbody = document.querySelector("#notesTable tbody");
      headerRow.innerHTML = "";
      tbody.innerHTML = "";
      allRows = [];

      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);
      });

      const uids = uidParam ? [uidParam] : Object.keys(parcels);
      uids.forEach(uid => {
        const row = document.createElement("tr");
        const parcel = parcels[uid] || {};
        const fb = fbData[uid] || {};
        const notes = Array.isArray(fb.notes) ? fb.notes : Object.values(fb.notes || []);
        const status = fb.status || "New";

        row.dataset.uid = uid;
        row.dataset.searchable = `${uid} ${parcel.Property || ""} ${parcel.Parent || ""} ${status} ${notes.map(n => n.text).join(" ")}`.toLowerCase();
        row.dataset.hasOpenRequest = notes.some(n => n.request && n.requestStatus !== "closed");

        columns.forEach(col => {
          const td = document.createElement("td");

          if (col === "uid") td.textContent = uid;
          else if (config.columns.includes(col)) td.textContent = parcel[col] || "";
          else if (col === "Status") {
            const sel = document.createElement("select");
            config.statuses.forEach(s => {
              const opt = document.createElement("option");
              opt.value = s.name;
              opt.textContent = s.name;
              if (s.name === status) opt.selected = true;
              sel.appendChild(opt);
            });
            td.appendChild(sel);
          }
          else if (col === "New Note") {
            td.innerHTML = `
              <textarea></textarea>
              <label><input type="checkbox" class="reqCheck" /> This is a request</label>
              <input type="text" placeholder="Assign to..." class="assignBox" style="display:none;" />
            `;
            td.querySelector(".reqCheck").onchange = e => {
              td.querySelector(".assignBox").style.display = e.target.checked ? "block" : "none";
            };
          }
          else if (col === "Save") {
            const btn = document.createElement("button");
            btn.textContent = "💾";
            btn.onclick = async () => {
              const sel = row.querySelector("select");
              const note = row.querySelector("textarea").value.trim();
              const req = row.querySelector(".reqCheck").checked;
              const assignee = row.querySelector(".assignBox").value.trim();
              if (!note && !sel.value) return;

              const newNote = { text: note, user: currentUser, timestamp: new Date().toISOString() };
              if (req) {
                newNote.request = true;
                newNote.assignedTo = assignee || "Unassigned";
                newNote.requestStatus = "open";
              }

              const notesRef = child(ref(db), `${uid}/notes`);
              const snap = await get(notesRef);
              const existing = snap.val() || [];
              const notesArr = Array.isArray(existing) ? existing : Object.values(existing);
              notesArr.push(newNote);
              await update(ref(db, uid), { status: sel.value, notes: notesArr });
              alert("Saved!"); location.reload();
            };
            td.appendChild(btn);
          }
          else if (col === "Note History") {
            td.innerHTML = notes.map((n, idx) => `
              <div style="margin-bottom:8px;">
                <strong>${n.user || "?"}:</strong> ${n.text || ""}<br/>
                <small>${n.timestamp || ""}</small><br/>
                ${n.request ? `<span class="request-tag">[Request]</span> Assigned to: ${n.assignedTo || "?"}<br/>
                  ${n.requestStatus !== "closed" ? `
                  <div class="reply-box">
                    <input type="text" placeholder="Reply..." data-uid="${uid}" data-index="${idx}" />
                    <button onclick="replyToRequest('${uid}', ${idx})">Reply</button>
                    <button onclick="closeRequest('${uid}', ${idx})">Close Request</button>
                  </div>` : `<em>(Closed)</em>`}
                ` : ""}
              </div>
            `).join("");
          }

          row.appendChild(td);
        });

        tbody.appendChild(row);
        allRows.push(row);
      });
    }

    window.replyToRequest = async (uid, idx) => {
      const input = document.querySelector(`input[data-uid="${uid}"][data-index="${idx}"]`);
      if (!input.value.trim()) return;
      const snap = await get(child(ref(db), `${uid}/notes`));
      const notes = Array.isArray(snap.val()) ? snap.val() : Object.values(snap.val());
      notes.push({ text: "🔁 " + input.value.trim(), user: currentUser, timestamp: new Date().toISOString() });
      await update(ref(db, uid), { notes });
      alert("Reply saved!"); location.reload();
    };

    window.closeRequest = async (uid, idx) => {
      const snap = await get(child(ref(db), `${uid}/notes`));
      const notes = Array.isArray(snap.val()) ? snap.val() : Object.values(snap.val());
      if (notes[idx]) notes[idx].requestStatus = "closed";
      await update(ref(db, uid), { notes });
      alert("Request closed!"); location.reload();
    };

    document.getElementById("searchInput").oninput = () => {
      const q = document.getElementById("searchInput").value.toLowerCase();
      allRows.forEach(r => {
        r.style.display = r.dataset.searchable.includes(q) ? "" : "none";
      });
    };

    document.getElementById("requestFilter").onchange = () => {
      const mode = document.getElementById("requestFilter").value;
      allRows.forEach(row => {
        const hasReq = row.dataset.hasOpenRequest === "true";
        row.style.display =
          mode === "all" ? "" :
          mode === "open" ? (hasReq ? "" : "none") :
          mode === "closed" ? (hasReq ? "none" : "") : "";
      });
    };

    await loadConfig();
    await loadParcels();
    await loadFirebase();
    buildTable();
  </script>
</body>
</html>
