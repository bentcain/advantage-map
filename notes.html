<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parcel Notes Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 14px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
      box-sizing: border-box;
    }
    th { white-space: nowrap; }
    input, select, textarea {
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
      overflow-y: hidden;
      max-width: 100%;
    }
    .reply-box { margin-top: 6px; }
    details summary { cursor: pointer; font-weight: bold; }

    td[data-col="uid"] {
      width: 100px;
      min-width: 100px;
      max-width: 100px;
    }
    td[data-col="Property"],
    td[data-col="Parent"] {
      width: 170px;
      min-width: 170px;
      max-width: 170px;
    }
    td[data-col="Acres"] {
      width: 113px;
      min-width: 113px;
      max-width: 113px;
    }
    td[data-col="Status"] {
      width: 120px;
      min-width: 120px;
      max-width: 120px;
    }
    td[data-col="Save"] {
      width: 15px !important;
      min-width: 15px;
      max-width: 15px;
      padding: 0;
      overflow: hidden;
    }
    td[data-col="Save"] button {
      width: 100%;
      padding: 0;
      text-align: center;
      font-size: 16px;
      line-height: 1;
      overflow: hidden;
    }
    td[data-col="New Note"] {
      width: 350px;
      min-width: 350px;
      max-width: 350px;
    }
    td[data-col="Note History"] {
      min-width: 500px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
  </style>
</head>
<body>
  <h2>Parcel Notes Dashboard</h2>
  <input type="text" id="searchInput" placeholder="Search..." />
  <table id="notesTable">
    <thead>
      <tr id="filterRow"></tr>
      <tr id="headerRow"></tr>
    </thead>
    <tbody></tbody>
  </table>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-app.js";
    import { getDatabase, ref, child, get, update } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-database.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const uidParam = new URLSearchParams(window.location.search).get("uid");
    const currentUser = sessionStorage.getItem("username") || "Unknown User";

    let config = {}, statusColors = {}, statusOrder = {}, parcels = {}, fbData = {};
    let allRows = [];

    async function loadConfig() {
      const res = await fetch("project_config.json");
      config = await res.json();
      config.statuses.forEach(s => {
        statusColors[s.name] = s.color;
        statusOrder[s.name.toLowerCase()] = s.order;
      });
    }

    async function loadGeojson() {
      const file = await fetch("geojson_filename.txt").then(r => r.text());
      const data = await fetch(file.trim()).then(r => r.json());
      data.features.forEach(f => {
        const uid = f.properties.uid;
        if (uid) parcels[uid] = f.properties;
      });
    }

    async function loadFirebase() {
      const snapshot = await get(ref(db));
      fbData = snapshot.val() || {};
    }

    function buildTable() {
      const uids = uidParam ? [uidParam] : Object.keys(parcels);
      const dynamicCols = config.columns.filter(c => c !== "uid" && c !== "Status");
      const columns = ["uid", ...dynamicCols.slice(0, 3), "Status", "New Note", "Save", "Note History"];

      const headerRow = document.getElementById("headerRow");
      const filterRow = document.getElementById("filterRow");
      const tbody = document.querySelector("#notesTable tbody");
      headerRow.innerHTML = "";
      filterRow.innerHTML = "";
      tbody.innerHTML = "";

      columns.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col;
        th.dataset.col = col;
        headerRow.appendChild(th);

        const fth = document.createElement("th");
        if (!["New Note", "Save", "Note History"].includes(col)) {
          const sel = document.createElement("select");
          sel.innerHTML = `<option value="">All</option>`;
          sel.dataset.col = col;
          sel.className = "filter";
          fth.appendChild(sel);
        }
        filterRow.appendChild(fth);
      });

      const rowData = [];

      uids.forEach(uid => {
        const parcel = parcels[uid] || {};
        const fb = fbData[uid] || {};
        const status = fb.status || parcel.Status || "New";
        const notes = Array.isArray(fb.notes) ? fb.notes : Object.values(fb.notes || {});
        const tr = document.createElement("tr");
        tr.style.backgroundColor = statusColors[status] || "";

        const searchable = `${uid} ${dynamicCols.map(k => parcel[k] || "").join(" ")} ${status} ${notes.map(n => n.text).join(" ")}`.toLowerCase();
        tr.dataset.searchable = searchable;

        columns.forEach(col => {
          const td = document.createElement("td");
          td.dataset.col = col;

          if (col === "uid") td.textContent = uid;
          else if (dynamicCols.includes(col)) td.textContent = parcel[col] || "";
          else if (col === "Status") {
            const sel = document.createElement("select");
            sel.className = "status";
            config.statuses.forEach(s => {
              const opt = document.createElement("option");
              opt.value = s.name;
              opt.textContent = s.name;
              if (s.name === status) opt.selected = true;
              sel.appendChild(opt);
            });
            td.appendChild(sel);
          }
          else if (col === "New Note") {
            const ta = document.createElement("textarea");
            ta.className = "note";
            ta.placeholder = "Add note...";
            ta.rows = 2;
            ta.oninput = () => autoGrow(ta);
            td.appendChild(ta);
          }
          else if (col === "Save") {
            const btn = document.createElement("button");
            btn.textContent = "💾";
            btn.onclick = () => {
              const status = tr.querySelector("select.status").value;
              const note = tr.querySelector("textarea.note").value.trim();
              if (!note) return;

              const noteObj = {
                text: note,
                user: currentUser,
                timestamp: new Date().toISOString()
              };

              const noteRef = child(ref(db), `${uid}/notes`);
              get(noteRef).then(snapshot => {
                const existing = snapshot.val() || [];
                const notes = Array.isArray(existing) ? existing : Object.values(existing);
                notes.push(noteObj);
                update(ref(db, uid), { status, notes }).then(() => location.reload());
              });
            };
            td.appendChild(btn);
          }
          else if (col === "Note History") {
            if (!notes.length) {
              td.innerHTML = "<em>No notes</em>";
            } else {
              const summary = document.createElement("details");
              const sum = document.createElement("summary");
              sum.textContent = `View ${notes.length} note(s)`;
              summary.appendChild(sum);
              notes.forEach((n, i) => {
                const block = document.createElement("div");
                block.innerHTML = `
                  <strong>${n.user || "?"}:</strong> ${n.text}<br>
                  <small>${n.timestamp || ""}</small>
                  <div class="reply-box">
                    <textarea id="reply-${uid}-${i}" rows="1" placeholder="Reply..." oninput="autoGrow(this)"></textarea>
                    <button onclick="replyToNote('${uid}', 'reply-${uid}-${i}')">Reply</button>
                  </div>
                  <hr>`;
                summary.appendChild(block);
              });
              td.appendChild(summary);
            }
          }

          tr.appendChild(td);
        });

        const order = statusOrder[status.toLowerCase()] || 99;
        rowData.push({ tr, order });
      });

      rowData.sort((a, b) => a.order - b.order).forEach(r => tbody.appendChild(r.tr));

      document.querySelectorAll("select.filter").forEach(sel => {
        const col = sel.dataset.col;
        const idx = columns.indexOf(col);
        const values = new Set();
        rowData.forEach(row => {
          const val = row.tr.cells[idx]?.textContent;
          if (val) values.add(val);
        });
        [...values].sort().forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", applyFilters);
      });
    }

    function applyFilters() {
      const terms = {};
      document.querySelectorAll("select.filter").forEach(sel => {
        if (sel.value) terms[sel.dataset.col] = sel.value;
      });

      document.querySelectorAll("tbody tr").forEach(tr => {
        const visible = Object.entries(terms).every(([col, val]) => {
          const cell = Array.from(tr.children).find(td => td.dataset.col === col);
          return cell?.textContent.includes(val);
        });
        tr.style.display = visible ? "" : "none";
      });
    }

    window.replyToNote = (uid, replyId) => {
      const textarea = document.getElementById(replyId);
      const replyText = textarea?.value?.trim();
      if (!replyText) return;

      const noteObj = {
        text: "🔁 " + replyText,
        user: currentUser,
        timestamp: new Date().toISOString()
      };

      const noteRef = child(ref(db), `${uid}/notes`);
      get(noteRef).then(snapshot => {
        const existing = snapshot.val() || [];
        const notes = Array.isArray(existing) ? existing : Object.values(existing);
        notes.push(noteObj);
        update(ref(db, uid), { notes }).then(() => location.reload());
      });
    };

    window.autoGrow = function(textarea) {
      textarea.style.height = "auto";
      textarea.style.height = textarea.scrollHeight + "px";
    };

    document.getElementById("searchInput").addEventListener("input", () => {
      const term = document.getElementById("searchInput").value.toLowerCase();
      document.querySelectorAll("tbody tr").forEach(tr => {
        tr.style.display = tr.dataset.searchable.includes(term) ? "" : "none";
      });
    });

    await loadConfig();
    await loadGeojson();
    await loadFirebase();
    buildTable();
  </script>
</body>
</html>
