<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parcel Notes Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 6px; vertical-align: top; }
    input, select, textarea { width: 100%; font-size: 14px; }
    textarea { resize: vertical; }
    .filter-bar { margin-top: 10px; display: flex; gap: 20px; align-items: center; }
  </style>
</head>
<body>
  <h2>Parcel Notes Dashboard</h2>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Search..." />
    <label for="requestFilter">Request Filter:</label>
    <select id="requestFilter">
      <option value="all">All Notes</option>
      <option value="requests">Requests Only</option>
      <option value="open">Open Requests</option>
      <option value="closed">Closed Requests</option>
    </select>
  </div>

  <table id="notesTable">
    <thead>
      <tr id="filterRow"></tr>
      <tr id="headerRow"></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-app.js";
    import { getDatabase, ref, child, get, update } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-database.js";
    import { firebaseConfig } from './firebase-config.js';

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const uidParam = new URLSearchParams(window.location.search).get("uid");
    const currentUser = localStorage.getItem("username") || "Ben";

    let config = {}, statusColors = {}, statusOrder = {}, parcels = {}, fbData = {};
    let allRows = [];

    async function loadConfig() {
      const res = await fetch("project_config.json");
      config = await res.json();
      config.statuses.forEach(s => {
        statusColors[s.name] = s.color;
        statusOrder[s.name.toLowerCase()] = s.order;
      });
    }

    async function loadGeojson() {
      const file = await fetch("geojson_filename.txt").then(r => r.text());
      const data = await fetch(file.trim()).then(r => r.json());
      data.features.forEach(f => {
        const uid = f.properties.uid;
        if (uid) parcels[uid] = f.properties;
      });
    }

    async function loadFirebase() {
      const snapshot = await get(ref(db));
      fbData = snapshot.val() || {};
    }

    function buildTable() {
      const uids = uidParam ? [uidParam] : Object.keys(parcels);
      const dynamicCols = config.columns.filter(c => c !== "uid");
      const columns = ["uid", ...dynamicCols.slice(0, 2), "Status", "New Note", "Save", "Note History"];

      const headerRow = document.getElementById("headerRow");
      const filterRow = document.getElementById("filterRow");
      const tbody = document.querySelector("#notesTable tbody");
      headerRow.innerHTML = "";
      filterRow.innerHTML = "";
      tbody.innerHTML = "";
      allRows = [];

      columns.forEach(col => {
        headerRow.innerHTML += `<th>${col}</th>`;
        const fth = document.createElement("th");
        if (!["New Note", "Save", "Note History"].includes(col)) {
          const sel = document.createElement("select");
          sel.innerHTML = `<option value="">All</option>`;
          sel.dataset.col = col;
          sel.className = "filter";
          fth.appendChild(sel);
        }
        filterRow.appendChild(fth);
      });

      uids.sort((a, b) => {
        const sa = (fbData[a]?.status || "New").toLowerCase();
        const sb = (fbData[b]?.status || "New").toLowerCase();
        return (statusOrder[sa] || 99) - (statusOrder[sb] || 99);
      });

      uids.forEach(uid => {
        const parcel = parcels[uid] || {};
        const fb = fbData[uid] || {};
        const status = fb.status || "New";
        const notes = Array.isArray(fb.notes) ? fb.notes : Object.values(fb.notes || {});
        const requests = fbData.requests?.[uid] || {};

        const replies = [];
        Object.values(requests).forEach(r => {
          (r.comments || []).forEach(c => {
            replies.push({ text: "üîÅ " + c.text, user: c.user, timestamp: c.timestamp, request: true, state: r.status });
          });
        });

        const fullNotes = [...notes, ...replies].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        const tr = document.createElement("tr");
        tr.style.backgroundColor = statusColors[status] || "";
        const searchable = `${uid} ${dynamicCols.map(k => parcel[k] || "").join(" ")} ${status} ${fullNotes.map(n => n.text).join(" ")}`.toLowerCase();
        tr.dataset.searchable = searchable;

        const noteStatuses = fullNotes.map(n => {
          if (n.request && n.state === "closed") return "closed";
          if (n.request) return "open";
          return "note";
        });
        tr.dataset.requestStatus = noteStatuses.includes("open")
          ? "open"
          : noteStatuses.includes("closed")
          ? "closed"
          : "note";

        columns.forEach(col => {
          const td = document.createElement("td");
          if (col === "uid") td.textContent = uid;
          else if (dynamicCols.includes(col)) td.textContent = parcel[col] || "";
          else if (col === "Status") {
            const sel = document.createElement("select");
            sel.className = "status";
            config.statuses.forEach(s => {
              const opt = document.createElement("option");
              opt.value = s.name;
              opt.textContent = s.name;
              if (s.name === status) opt.selected = true;
              sel.appendChild(opt);
            });
            td.appendChild(sel);
          } else if (col === "New Note") {
            const ta = document.createElement("textarea");
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            const label = document.createElement("label");
            label.appendChild(checkbox);
            label.append(" This is a request");

            const assignBox = document.createElement("input");
            assignBox.placeholder = "Assign To...";
            assignBox.style.display = "none";

            checkbox.onchange = () => {
              assignBox.style.display = checkbox.checked ? "block" : "none";
            };

            td.appendChild(ta);
            td.appendChild(label);
            td.appendChild(assignBox);
          } else if (col === "Save") {
            const btn = document.createElement("button");
            btn.textContent = "üíæ";
            btn.onclick = () => {
              const status = tr.querySelector("select.status").value;
              const note = tr.querySelector("textarea").value.trim();
              const request = tr.querySelector("input[type='checkbox']").checked;
              const assignee = tr.querySelector("input[placeholder='Assign To...']").value.trim();

              const noteObj = {
                text: note,
                user: currentUser,
                timestamp: new Date().toISOString()
              };

              const noteRef = child(ref(db), `${uid}/notes`);
              get(noteRef).then(snapshot => {
                const existing = snapshot.val() || [];
                const notes = Array.isArray(existing) ? existing : Object.values(existing);
                if (note) notes.push(noteObj);

                update(ref(db, uid), { status, notes }).then(() => {
                  if (request) {
                    const reqId = `${Date.now()}_${currentUser.toLowerCase()}`;
                    const req = {
                      text: note,
                      createdBy: currentUser,
                      assignedTo: assignee || "Unassigned",
                      status: "open",
                      createdAt: new Date().toISOString(),
                      comments: []
                    };
                    update(ref(db, `requests/${uid}/${reqId}`), req);
                  }
                  alert("Saved!");
                  location.reload();
                });
              });
            };
            td.appendChild(btn);
          } else if (col === "Note History") {
            td.innerHTML = fullNotes.map(n => {
              const type = n.request ? (n.text.startsWith("üîÅ") ? "reply" : "request") : "note";
              const style = type === "reply"
                ? "color:#004;"
                : type === "request"
                ? "background:#ffe;border-left:4px solid orange;padding:5px;"
                : "";
              return `<div style="${style}"><strong>${n.user || "?"}:</strong> ${n.text}<br><small>${n.timestamp || ""}</small></div><hr>`;
            }).join("") || "<em>No notes</em>";
          }
          tr.appendChild(td);
        });

        allRows.push(tr);
        tbody.appendChild(tr);
      });

      document.querySelectorAll("select.filter").forEach(sel => {
        const col = sel.dataset.col;
        const idx = columns.indexOf(col);
        const values = new Set();
        allRows.forEach(row => {
          const val = row.cells[idx]?.textContent;
          if (val) values.add(val);
        });
        [...values].sort().forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          sel.appendChild(opt);
        });
        sel.addEventListener("change", applyFilters);
      });
    }

    function applyFilters() {
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      const requestFilter = document.getElementById("requestFilter").value;
      const filters = {};
      document.querySelectorAll("select.filter").forEach(sel => {
        if (sel.value) filters[sel.dataset.col] = sel.value;
      });

      allRows.forEach(row => {
        const matchesSearch = row.dataset.searchable.includes(searchTerm);
        const matchesRequest = requestFilter === "all" || row.dataset.requestStatus === requestFilter;
        const matchesColumn = Object.entries(filters).every(([col, val]) => {
          const idx = [...row.cells].findIndex(td => td.parentElement.children[idx]?.textContent === col);
          return row.cells[idx]?.textContent.includes(val);
        });

        row.style.display = matchesSearch && matchesRequest && matchesColumn ? "" : "none";
      });
    }

    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("requestFilter").addEventListener("change", applyFilters);

    await loadConfig();
    await loadGeojson();
    await loadFirebase();
    buildTable();
  </script>
</body>
</html>
