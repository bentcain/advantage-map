<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parcel Notes Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
    }
    textarea, input[type="text"], select {
      width: 98%;
    }
    .requestDetails {
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h2>Parcel Notes Dashboard</h2>
  <table id="notesTable">
    <thead>
      <tr>
        <th>UID</th>
        <th>Status</th>
        <th>New Note</th>
        <th>Submit</th>
        <th>Note History</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
      authDomain: "parcel-notes-system.firebaseapp.com",
      projectId: "parcel-notes-system",
      storageBucket: "parcel-notes-system.appspot.com",
      messagingSenderId: "538142262863",
      appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
      measurementId: "G-GQ3CQ9EKPH",
      databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const uidParam = new URLSearchParams(window.location.search).get("uid");
    const statusOptions = ["New", "Follow Up 1", "Follow Up 2", "Follow Up 3", "On Hold", "Conversion", "Not Interested"];
    const currentUser = localStorage.getItem("username") || "Ben";

    function renderRow(uid, data) {
      const row = document.createElement("tr");

      const uidCell = document.createElement("td");
      uidCell.textContent = uid;
      row.appendChild(uidCell);

      const statusCell = document.createElement("td");
      const statusSelect = document.createElement("select");
      statusOptions.forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        if (data.status === option) opt.selected = true;
        statusSelect.appendChild(opt);
      });
      statusCell.appendChild(statusSelect);
      row.appendChild(statusCell);

      const noteCell = document.createElement("td");
      const noteInput = document.createElement("textarea");
      noteCell.appendChild(noteInput);

      const requestToggle = document.createElement("label");
      const requestCheckbox = document.createElement("input");
      requestCheckbox.type = "checkbox";
      requestToggle.appendChild(requestCheckbox);
      requestToggle.append(" This is a request");

      const requestDetails = document.createElement("div");
      requestDetails.className = "requestDetails";
      requestDetails.style.display = "none";
      const assignLabel = document.createElement("label");
      assignLabel.textContent = "Assign To: ";
      const assignInput = document.createElement("input");
      assignInput.type = "text";
      assignInput.placeholder = "e.g. Jeff";
      assignInput.className = "assignToInput";
      assignLabel.appendChild(assignInput);
      requestDetails.appendChild(assignLabel);

      requestCheckbox.onchange = () => {
        requestDetails.style.display = requestCheckbox.checked ? "block" : "none";
      };

      noteCell.appendChild(document.createElement("br"));
      noteCell.appendChild(requestToggle);
      noteCell.appendChild(requestDetails);
      row.appendChild(noteCell);

      const saveCell = document.createElement("td");
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Save";
      saveBtn.onclick = () => {
        const statusVal = statusSelect.value;
        const noteVal = noteInput.value.trim();
        const isRequest = requestCheckbox.checked;
        const assignTo = assignInput.value.trim();

        const updates = { status: statusVal };

        if (noteVal) {
          const newNote = {
            text: noteVal,
            user: currentUser,
            timestamp: new Date().toISOString()
          };

          db.ref(uid).child("notes").once("value").then(snapshot => {
            const existingNotes = snapshot.val() || [];
            const noteArray = Array.isArray(existingNotes) ? existingNotes : Object.values(existingNotes);
            noteArray.push(newNote);

            db.ref(uid).update({
              status: statusVal,
              notes: noteArray
            });

            if (isRequest) {
              const requestId = `${Date.now()}_${currentUser.toLowerCase()}`;
              const request = {
                text: noteVal,
                createdBy: currentUser,
                assignedTo: assignTo || "Unassigned",
                status: "open",
                createdAt: new Date().toISOString(),
                comments: []
              };
              db.ref("requests").child(uid).child(requestId).set(request);
            }

            alert("Note saved" + (isRequest ? " with request." : "."));
            location.reload();
          });
        } else {
          db.ref(uid).update({ status: statusVal });
          alert("Status updated.");
          location.reload();
        }
      };
      saveCell.appendChild(saveBtn);
      row.appendChild(saveCell);

      const historyCell = document.createElement("td");

      // Load both standard notes and request comments
      Promise.all([
        db.ref(uid).child("notes").once("value"),
        db.ref("requests").child(uid).once("value")
      ]).then(([noteSnap, requestSnap]) => {
        const noteArray = Array.isArray(noteSnap.val()) ? noteSnap.val() : Object.values(noteSnap.val() || {});
        const requestData = requestSnap.val() || {};
        let requestComments = [];
        Object.values(requestData).forEach(req => {
          const comments = req.comments || [];
          comments.forEach(comment => {
            requestComments.push({
              text: "🔁 Reply to request: " + comment.text,
              user: comment.user,
              timestamp: comment.timestamp
            });
          });
        });

        const all = [...noteArray, ...requestComments];
        all.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        if (all.length === 0) {
          historyCell.innerHTML = "<em>No notes</em>";
        } else {
          historyCell.innerHTML = all.map(note =>
            `<div><strong>${note.user || "Unknown"}:</strong> ${note.text} <br><small>${note.timestamp || ""}</small></div><hr>`
          ).join("");
        }

        row.appendChild(historyCell);
        document.querySelector("#notesTable tbody").appendChild(row);
      });
    }

    db.ref().once("value").then(snapshot => {
      const all = snapshot.val() || {};
      const filtered = uidParam ? { [uidParam]: all[uidParam] } : all;
      Object.entries(filtered).forEach(([uid, data]) => renderRow(uid, data));
    });
  </script>
</body>
</html>
