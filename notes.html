<!DOCTYPE html>
<html>
<head>
  <title>Parcel Notes Dashboard</title>
  <meta charset="utf-8" />
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .note { margin-bottom: 1em; padding: 1em; border: 1px solid #ccc; }
    .note small { color: #666; display: block; margin-top: 0.5em; }
  </style>
</head>
<body>
  <h2>📋 Parcel Notes Dashboard</h2>
  <div id="info">Loading...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
      authDomain: "parcel-notes-system.firebaseapp.com",
      projectId: "parcel-notes-system",
      storageBucket: "parcel-notes-system.appspot.com",
      messagingSenderId: "538142262863",
      appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
      databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const uid = new URLSearchParams(window.location.search).get("uid");
    const info = document.getElementById("info");

    if (!uid) {
      info.innerHTML = "❌ No UID specified in URL. Use ?uid=parcel_XXXXX";
      throw new Error("Missing UID");
    }

    const parcelRef = ref(db, uid);
    onValue(parcelRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) {
        info.innerHTML = "No notes found for " + uid;
        return;
      }

      const { status = "Unknown", notes = {} } = data;
      const entries = Object.values(notes).sort((a, b) =>
        (b.timestamp || "").localeCompare(a.timestamp || "")
      );

      let html = `<p><b>Parcel:</b> ${uid}</p>`;
      html += `<p><b>Current Status:</b> ${status}</p>`;
      html += `<h3>📌 Note History</h3>`;
      if (entries.length === 0) {
        html += `<p>No notes yet.</p>`;
      } else {
        entries.forEach(note => {
          html += `<div class="note"><b>${note.status}</b>: ${note.text}<small>${note.timestamp}</small></div>`;
        });
      }

      info.innerHTML = html;
    }, {
      onlyOnce: false
    });
  </script>
</body>
</html>
