<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Parcel Notes Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      vertical-align: top;
    }
    textarea, input[type="text"], select {
      width: 98%;
    }
    select.filter {
      width: 100%;
      margin-bottom: 4px;
    }
    .requestDetails {
      margin-top: 4px;
    }
    .New { background-color: #ffffff; }
    .Follow_Up { background-color: #ffe699; }
    .On_Hold { background-color: #d9d9d9; }
    .Conversion { background-color: #c6efce; }
    .Not_Interested { background-color: #f4cccc; }
  </style>
</head>
<body>
  <h2>Parcel Notes Dashboard</h2>
  <table id="notesTable">
    <thead>
      <tr id="filterRow"></tr>
      <tr>
        <th>UID</th>
        <th>Status</th>
        <th>New Note</th>
        <th>Submit</th>
        <th>Note History</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
      authDomain: "parcel-notes-system.firebaseapp.com",
      projectId: "parcel-notes-system",
      storageBucket: "parcel-notes-system.appspot.com",
      messagingSenderId: "538142262863",
      appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
      measurementId: "G-GQ3CQ9EKPH",
      databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const uidParam = new URLSearchParams(window.location.search).get("uid");
    const statusOptions = ["New", "Follow Up 1", "Follow Up 2", "Follow Up 3", "On Hold", "Conversion", "Not Interested"];
    const currentUser = localStorage.getItem("username") || "Ben";

    let allData = [];

    function createFilterRow() {
      const filterRow = document.getElementById("filterRow");
      filterRow.innerHTML = "";
      const keys = ["uid", "status", "", "", "text"];
      keys.forEach((key, i) => {
        const th = document.createElement("th");
        if (key) {
          const values = [...new Set(allData.map(row => row[key] || ""))].sort();
          const select = document.createElement("select");
          select.className = "filter";
          select.dataset.index = i;
          select.innerHTML = `<option value="">All</option>` + values.map(v => `<option>${v}</option>`).join("");
          select.onchange = filterTable;
          th.appendChild(select);
        }
        filterRow.appendChild(th);
      });
    }

    function filterTable() {
      const filters = Array.from(document.querySelectorAll("select.filter")).map(s => s.value);
      const rows = document.querySelectorAll("#notesTable tbody tr");
      rows.forEach(row => {
        let show = true;
        filters.forEach((val, i) => {
          if (val && !row.children[i].innerText.includes(val)) {
            show = false;
          }
        });
        row.style.display = show ? "" : "none";
      });
    }

    function renderRow(uid, data, noteHistory) {
      const row = document.createElement("tr");
      const safeStatus = (data.status || "").replace(/ /g, "_");
      if (safeStatus) row.classList.add(safeStatus);

      // Track for filter dropdowns
      allData.push({
        uid,
        status: data.status || "",
        text: noteHistory.map(n => n.text).join(" || ")
      });

      const uidCell = document.createElement("td");
      uidCell.textContent = uid;
      row.appendChild(uidCell);

      const statusCell = document.createElement("td");
      const statusSelect = document.createElement("select");
      statusOptions.forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option;
        if (data.status === option) opt.selected = true;
        statusSelect.appendChild(opt);
      });
      statusCell.appendChild(statusSelect);
      row.appendChild(statusCell);

      const noteCell = document.createElement("td");
      const noteInput = document.createElement("textarea");
      noteCell.appendChild(noteInput);

      const requestToggle = document.createElement("label");
      const requestCheckbox = document.createElement("input");
      requestCheckbox.type = "checkbox";
      requestToggle.appendChild(requestCheckbox);
      requestToggle.append(" This is a request");

      const requestDetails = document.createElement("div");
      requestDetails.className = "requestDetails";
      requestDetails.style.display = "none";
      const assignLabel = document.createElement("label");
      assignLabel.textContent = "Assign To: ";
      const assignInput = document.createElement("input");
      assignInput.type = "text";
      assignInput.placeholder = "e.g. Jeff";
      assignInput.className = "assignToInput";
      assignLabel.appendChild(assignInput);
      requestDetails.appendChild(assignLabel);

      requestCheckbox.onchange = () => {
        requestDetails.style.display = requestCheckbox.checked ? "block" : "none";
      };

      noteCell.appendChild(document.createElement("br"));
      noteCell.appendChild(requestToggle);
      noteCell.appendChild(requestDetails);
      row.appendChild(noteCell);

      const saveCell = document.createElement("td");
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Save";
      saveBtn.onclick = () => {
        const statusVal = statusSelect.value;
        const noteVal = noteInput.value.trim();
        const isRequest = requestCheckbox.checked;
        const assignTo = assignInput.value.trim();

        if (noteVal) {
          const newNote = {
            text: noteVal,
            user: currentUser,
            timestamp: new Date().toISOString()
          };

          db.ref(uid).child("notes").once("value").then(snapshot => {
            const existingNotes = snapshot.val() || [];
            const noteArray = Array.isArray(existingNotes) ? existingNotes : Object.values(existingNotes);
            noteArray.push(newNote);

            db.ref(uid).update({
              status: statusVal,
              notes: noteArray
            });

            if (isRequest) {
              const requestId = `${Date.now()}_${currentUser.toLowerCase()}`;
              const request = {
                text: noteVal,
                createdBy: currentUser,
                assignedTo: assignTo || "Unassigned",
                status: "open",
                createdAt: new Date().toISOString(),
                comments: []
              };
              db.ref("requests").child(uid).child(requestId).set(request);
            }

            alert("Note saved" + (isRequest ? " with request." : "."));
            location.reload();
          });
        } else {
          db.ref(uid).update({ status: statusVal });
          alert("Status updated.");
          location.reload();
        }
      };
      saveCell.appendChild(saveBtn);
      row.appendChild(saveCell);

      const historyCell = document.createElement("td");
      historyCell.innerHTML = noteHistory.map(note =>
        `<div><strong>${note.user || "Unknown"}:</strong> ${note.text} <br><small>${note.timestamp || ""}</small></div><hr>`
      ).join("") || "<em>No notes</em>";
      row.appendChild(historyCell);

      document.querySelector("#notesTable tbody").appendChild(row);
    }

    db.ref().once("value").then(snapshot => {
      const all = snapshot.val() || {};
      const targetUIDs = uidParam ? [uidParam] : Object.keys(all);
      Promise.all(targetUIDs.map(uid => {
        return Promise.all([
          db.ref(uid).child("notes").once("value"),
          db.ref("requests").child(uid).once("value")
        ]).then(([noteSnap, requestSnap]) => {
          const notes = Array.isArray(noteSnap.val()) ? noteSnap.val() : Object.values(noteSnap.val() || {});
          const requestData = requestSnap.val() || {};
          const requestReplies = [];
          Object.values(requestData).forEach(req => {
            (req.comments || []).forEach(c => {
              requestReplies.push({
                text: "🔁 Reply to request: " + c.text,
                user: c.user,
                timestamp: c.timestamp
              });
            });
          });
          const allNotes = [...notes, ...requestReplies].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
          renderRow(uid, all[uid], allNotes);
        });
      })).then(() => createFilterRow());
    });
  </script>
</body>
</html>
