<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Interactive Parcel Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.7/dist/leaflet-search.min.css" />
    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
        }
        .leaflet-popup-content {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-search@3.0.7/dist/leaflet-search.min.js"></script>
    <script>
        const map = L.map('map').setView([39.8, -89.6], 7);

        // Satellite basemap
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles Â© Esri',
            maxZoom: 19
        }).addTo(map);

        // Load GeoJSON file dynamically
        fetch('advantage_geojson.geojson?v=' + Date.now())
            .then(response => {
                if (!response.ok) throw new Error("GeoJSON file load failed");
                return response.json();
            })
            .then(data => {
                const geoLayer = L.geoJSON(data, {
                    onEachFeature: function (feature, layer) {
                        const props = feature.properties || {};
                        const center = layer.getBounds().getCenter();
                        let popupContent = '<table>';
                        for (const key in props) {
                            popupContent += `<tr><td><strong>${key}</strong></td><td>${props[key]}</td></tr>`;
                        }
                        popupContent += `</table><br><a href="https://www.google.com/maps?q=&layer=c&cbll=${center.lat},${center.lng}" target="_blank">Street View</a>`;
                        layer.bindPopup(popupContent);
                    }
                }).addTo(map);

                map.fitBounds(geoLayer.getBounds());

                // Add dynamic full-field search
                const searchControl = new L.Control.Search({
                    layer: geoLayer,
                    propertyName: '', // Search across all fields
                    textPlaceholder: 'Search parcels...',
                    marker: false,
                    moveToLocation: function (latlng, title, map) {
                        map.setView(latlng, 17);

                        // Add red highlight circle to selected result
                        if (window.searchMarker) map.removeLayer(window.searchMarker);
                        window.searchMarker = L.circleMarker(latlng, {
                            radius: 10,
                            color: 'red',
                            fillColor: 'red',
                            fillOpacity: 0.6
                        }).addTo(map);
                    },
                    buildTip: function(text, val) {
                        return `<span>${text}</span>`;
                    },
                    sourceData: function(text, callResponse) {
                        const results = [];
                        geoLayer.eachLayer(layer => {
                            const props = layer.feature.properties;
                            const allText = Object.values(props).join(' ').toLowerCase();
                            if (allText.includes(text.toLowerCase())) {
                                results.push({
                                    name: allText,
                                    latlng: layer.getBounds().getCenter(),
                                    layer: layer
                                });
                            }
                        });
                        callResponse(results);
                    }
                });

                map.addControl(searchControl);
            })
            .catch(error => {
                alert("Could not load the GeoJSON file. Please verify the name was injected and the file exists.");
                console.error(error);
            });
    </script>
</body>
</html>
