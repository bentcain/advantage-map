<!DOCTYPE html>
<html>
<head>
  <title>Advantage Interactive Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.3/dist/leaflet-search.min.css" />
  <style>
    #map { height: 100vh; }
    .legend {
      background: white;
      padding: 10px;
      line-height: 18px;
      color: #333;
    }
    .legend span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 6px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet-search@2.9.3/dist/leaflet-search.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAJDMU7z63a4XAbqJmN1WxCRXlLIAIrYdA",
  authDomain: "advantage-map.firebaseapp.com",
  databaseURL: "https://advantage-map-default-rtdb.firebaseio.com",
  projectId: "advantage-map",
  storageBucket: "advantage-map.appspot.com",
  messagingSenderId: "189889031240",
  appId: "1:189889031240:web:fcffc4a5ef10e75a6975bc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script src="advantage_geojson.geojson" type="application/json" id="geojson-data"></script>
<script src="uid_map.json" type="application/json" id="uid-map"></script>

<script>
const map = L.map('map').setView([39.8, -89.65], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Load UID map
const uidMap = JSON.parse(document.getElementById("uid-map").textContent);

// Color logic
const statusColors = {
  "Conversion": "#FFA500",
  "Follow Up 1": "#1E90FF", "Follow Up 2": "#1E90FF", "Follow Up 3": "#1E90FF",
  "New": "#00FF00",
  "Not Interested": "#000000",
  "On Hold": "#800080"
};

// Build popups
function buildPopup(props, layer) {
  const uid = props.uid;
  const status = props.Status || "New";
  const projectId = props["Project ID"] || "Unknown";
  const acres = props.Acreage || "0";
  const name = `${projectId} - ${acres} acres`;

  let popup = `<b>${name}</b><br>`;
  for (let key in props) {
    if (!key.startsWith("_")) {
      popup += `<b>${key}:</b> ${props[key]}<br>`;
    }
  }
  popup += `
    <b>Lead Status:</b>
    <select id="status-${uid}">
      ${Object.keys(statusColors).map(s =>
        `<option value="${s}" ${s === status ? "selected" : ""}>${s}</option>`
      ).join("")}
    </select><br>
    <button onclick="saveStatus('${uid}')">Save</button><br><br>
    <textarea id="note-${uid}" rows="3" placeholder="Add Note" style="width:100%"></textarea><br>
    <button onclick="saveNote('${uid}')">Submit Note</button><br><br>
    <a href="notes.html?uid=${uid}" target="_blank">View Notes</a> |
    <a href="master.html" target="_blank">Open Dashboard</a>
  `;
  layer.bindPopup(popup);
}

function onEachFeature(feature, layer) {
  const props = feature.properties;
  if (!props.uid && props["Property"]) {
    const propKey = Object.values(props).join("|");
    props.uid = uidMap[propKey];
  }
  if (!props.uid) return;
  const status = props.Status || "New";
  const color = statusColors[status] || "#3388ff";
  layer.setStyle({ color, weight: 2, fillOpacity: 0.6 });
  buildPopup(props, layer);
}

function saveStatus(uid) {
  const status = document.getElementById(`status-${uid}`).value;
  db.ref("status/" + uid).set(status);
}

function saveNote(uid) {
  const note = document.getElementById(`note-${uid}`).value;
  const time = new Date().toISOString();
  db.ref("notes/" + uid).push({ text: note, time });
}

// Load GeoJSON
fetch("advantage_geojson.geojson")
  .then(res => res.json())
  .then(data => {
    const layer = L.geoJSON(data, {
      onEachFeature
    }).addTo(map);

    // SEARCH BAR
    const search = new L.Control.Search({
      layer,
      propertyName: 'Property',
      initial: false,
      zoom: 15,
      marker: false
    });
    map.addControl(search);

    search.on('search:locationfound', e => {
      e.layer.openPopup();
    });

    // LEGEND
    const legend = L.control({ position: "bottomleft" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "legend");
      div.innerHTML = "<strong>Lead Status</strong><br>";
      for (let key in statusColors) {
        if (["Follow Up 1", "Follow Up 2", "Follow Up 3"].includes(key)) continue;
        const label = key === "Follow Up 1" ? "Follow Up" : key;
        div.innerHTML += `<span style="background:${statusColors[key]}"></span>${label}<br>`;
      }
      return div;
    };
    legend.addTo(map);
  });
</script>
</body>
</html>
