<!DOCTYPE html>
<html>
<head>
  <title>Interactive Map</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, width=device-width">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>html, body, #map { margin: 0; height: 100%; }</style>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>
<body>
  <div id="map"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD7JkobzpJcrOHU_fNwXuEQqdYL1iAiiRQ",
  authDomain: "parcel-notes-system.firebaseapp.com",
  databaseURL: "https://parcel-notes-system-default-rtdb.firebaseio.com",
  projectId: "parcel-notes-system",
  storageBucket: "parcel-notes-system.appspot.com",
  messagingSenderId: "538142262863",
  appId: "1:538142262863:web:89dfd4cf60bb2dc4694c3a",
  measurementId: "G-GQ3CQ9EKPH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const map = L.map('map').setView([40, -89], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

fetch("geojson_filename.txt")
  .then(r => r.text())
  .then(name => fetch(name.trim()))
  .then(r => r.json())
  .then(data => {
    const layer = L.geoJSON(data, {
      onEachFeature: onEachFeature,
      style: { color: "#3388ff", weight: 2 }
    }).addTo(map);
    map.fitBounds(layer.getBounds());
  });

function onEachFeature(feature, layer) {
  const props = feature.properties;
  if (!props.uid) return;
  buildPopup(props, layer);
}

function buildPopup(properties, layer) {
  let content = "<b>Parcel Info:</b><br>";
  for (let key in properties) {
    if (key !== "_searchable" && properties[key] !== null) {
      content += `<strong>${key}:</strong> ${properties[key]}<br>`;
    }
  }

  const uid = properties.uid;
  const currentStatus = properties.Status || "New";

  content += `
    <hr>
    <label><strong>Lead Status:</strong></label>
    <select id="status-${uid}">
      ${["New", "New with Contact", "Follow Up 1", "Follow Up 2", "Follow Up 3", "On Hold", "Unqualified", "Not Interested", "Research Needed", "Research Completed", "No Response", "RR2", "RC2", "Unable To Contact", "Conversion"].map(status =>
        `<option value="${status}" ${status === currentStatus ? "selected" : ""}>${status}</option>`
      ).join("")}
    </select>
    <button onclick="saveStatus('${uid}')">Save</button><br><br>

    <label><strong>Add Note:</strong></label><br>
    <textarea id="note-${uid}" rows="3" style="width:100%"></textarea><br>
    <button onclick="saveNote('${uid}')">Submit Note</button>
  `;

  layer.bindPopup(content);
}

function saveStatus(uid) {
  const newStatus = document.getElementById(`status-${uid}`).value;
  db.ref("status/" + uid).set(newStatus);
  alert("Status updated!");
}

function saveNote(uid) {
  const note = document.getElementById(`note-${uid}`).value;
  const timestamp = new Date().toISOString();
  db.ref("notes/" + uid).push({ text: note, time: timestamp });
  alert("Note saved!");
}
</script>
</body>
</html>
