<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Interactive Parcel Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@3.0.7/dist/leaflet-search.min.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    .search-tip b {
      color: #fff;
      background: #2196f3;
      padding: 0 4px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-search@3.0.7/dist/leaflet-search.min.js"></script>

<script>
  const map = L.map('map').setView([39.8, -89.6], 6); // Illinois-centric default

  L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const geojsonFile = "advantage_geojson.geojson";

  fetch(geojsonFile)
    .then(response => {
      if (!response.ok) {
        throw new Error("GeoJSON fetch failed");
      }
      return response.json();
    })
    .then(data => {
      const allFeatures = L.geoJSON(data, {
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          let content = "<table>";
          for (const key in props) {
            content += `<tr><td><strong>${key}</strong></td><td>${props[key]}</td></tr>`;
          }
          content += "</table>";
          layer.bindPopup(content);
        }
      }).addTo(map);

      map.fitBounds(allFeatures.getBounds());

      // Build index of all fields
      const featuresIndex = [];
      data.features.forEach(f => {
        const props = f.properties;
        for (const key in props) {
          featuresIndex.push({
            loc: f.geometry,
            title: props[key],
            feature: f
          });
        }
      });

      new L.Control.Search({
        layer: allFeatures,
        sourceData: function(text, callResponse) {
          const matches = [];
          text = text.toLowerCase();
          for (let i = 0; i < featuresIndex.length; i++) {
            const val = String(featuresIndex[i].title).toLowerCase();
            if (val.includes(text)) {
              matches.push({
                loc: featuresIndex[i].loc,
                title: featuresIndex[i].title
              });
            }
          }
          callResponse(matches);
        },
        zoom: 17,
        initial: false,
        marker: false,
        autoType: false,
        textPlaceholder: "Search parcels..."
      }).addTo(map);
    })
    .catch(err => {
      alert("‚ùå Could not load the GeoJSON file.");
      console.error(err);
    });
</script>
</body>
</html>
