<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Parcel Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.css" />
  <style>
    html, body, #map { margin: 0; padding: 0; height: 100%; }
    #legend {
      background: white;
      padding: 10px;
      line-height: 1.5;
      font-size: 14px;
    }
    .legend-color-box {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin-right: 5px;
    }
    .leaflet-control-search { z-index: 1000; }
    #view-notes-btn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 14px;
      text-decoration: none;
      color: #333;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div id="map"></div>
<a id="view-notes-btn" href="notes.html" target="_blank">ðŸ“„ View Full Notes Table</a>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.js"></script>
<script src="firebase-config.js" type="module"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-app.js";
  import { getDatabase, ref, push, set, get, child, update } from "https://www.gstatic.com/firebasejs/11.7.0/firebase-database.js";
  import { firebaseConfig } from './firebase-config.js';

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const map = L.map('map').setView([39.8, -89.6], 8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const statusColors = {
    "new": "#1E90FF",
    "follow up": "#FFA500",
    "on hold": "#00FF00",
    "conversion": "#FF0000",
    "not interested": "#000000"
  };

  const getColor = (status) => {
    if (!status) return "#AAAAAA";
    const normalized = status.toLowerCase();
    if (normalized.includes("follow up")) return statusColors["follow up"];
    return statusColors[normalized] || "#AAAAAA";
  };

  const statusOptions = [
    "New", "New with Contact", "Follow Up 1", "Follow Up 2", "Follow Up 3",
    "On Hold", "Unqualified", "Not Interested", "Research Needed",
    "Research Completed", "No Response", "RR2", "RC2", "Unable To Contact", "Conversion"
  ];

  const geojsonFile = 'advantage_geojson.geojson';

  fetch(geojsonFile)
    .then(res => res.json())
    .then(data => {
      const geojsonLayer = L.geoJSON(data, {
        style: feature => ({
          color: "#555",
          weight: 1,
          fillOpacity: 0.7,
          fillColor: getColor(feature.properties.Status)
        }),
        onEachFeature: (feature, layer) => {
          const props = feature.properties;
          const uid = props.uid;
          const popupDiv = document.createElement("div");

          popupDiv.innerHTML = Object.entries(props).map(([key, value]) =>
            `<strong>${key}</strong>: ${value}`
          ).join("<br>");

          const statusDropdown = document.createElement("select");
          statusOptions.forEach(opt => {
            const option = document.createElement("option");
            option.value = opt;
            option.text = opt;
            if (opt.toLowerCase() === (props.Status || "").toLowerCase()) {
              option.selected = true;
            }
            statusDropdown.appendChild(option);
          });

          const noteBox = document.createElement("textarea");
          noteBox.rows = 2;
          noteBox.placeholder = "New Note";

          const saveBtn = document.createElement("button");
          saveBtn.textContent = "ðŸ’¾ Save";
          saveBtn.onclick = () => {
            const newStatus = statusDropdown.value;
            const newNote = noteBox.value;
            const timestamp = new Date().toISOString();

            if (newNote.trim() !== "") {
              push(ref(db, `${uid}/notes`), {
                text: newNote,
                timestamp,
                status: newStatus
              });
              noteBox.value = "";
            }

            update(ref(db, `${uid}`), { status: newStatus });

            // Update color dynamically
            updateParcelStyleByUID(uid, newStatus);
          };

          const notesLink = document.createElement("a");
          notesLink.href = `notes.html?uid=${uid}`;
          notesLink.textContent = "ðŸ“„ View Parcel Notes";
          notesLink.target = "_blank";

          const streetLink = document.createElement("a");
          streetLink.href = `https://www.google.com/maps?q=&layer=c&cbll=${layer.getBounds().getCenter().lat},${layer.getBounds().getCenter().lng}`;
          streetLink.textContent = "Street View";
          streetLink.target = "_blank";

          popupDiv.appendChild(document.createElement("br"));
          popupDiv.appendChild(document.createTextNode("Status"));
          popupDiv.appendChild(document.createElement("br"));
          popupDiv.appendChild(statusDropdown);
          popupDiv.appendChild(document.createElement("br"));
          popupDiv.appendChild(document.createTextNode("New Note"));
          popupDiv.appendChild(document.createElement("br"));
          popupDiv.appendChild(noteBox);
          popupDiv.appendChild(document.createElement("br"));
          popupDiv.appendChild(saveBtn);
          popupDiv.appendChild(document.createElement("br"));
          popupDiv.appendChild(notesLink);
          popupDiv.appendChild(document.createElement("br"));
          popupDiv.appendChild(streetLink);

          layer.bindPopup(popupDiv);
        }
      }).addTo(map);

      // Search
      const searchControl = new L.Control.Search({
        layer: geojsonLayer,
        propertyName: 'searchable',
        marker: false,
        moveToLocation: (latlng, title, map) => {
          map.setView(latlng, 16);
          const marker = L.circleMarker(latlng, {
            radius: 10,
            color: '#FF0000',
            weight: 2,
            fillColor: '#FF0000',
            fillOpacity: 0.5
          }).addTo(map);

          setTimeout(() => map.removeLayer(marker), 5000);
        }
      });
      map.addControl(searchControl);

      // Zoom to layer
      map.fitBounds(geojsonLayer.getBounds());

      // Legend
      const legend = L.control({ position: 'bottomleft' });
      legend.onAdd = () => {
        const div = L.DomUtil.create('div', 'info legend');
        div.id = "legend";
        div.innerHTML = "<strong>Lead Status</strong><br>";
        Object.entries(statusColors).forEach(([key, color]) => {
          div.innerHTML += `<span class="legend-color-box" style="background:${color}"></span>${key}<br>`;
        });
        return div;
      };
      legend.addTo(map);
    });

  function updateParcelStyleByUID(uid, newStatus) {
    map.eachLayer(layer => {
      if (layer.feature && layer.feature.properties && layer.feature.properties.uid === uid) {
        const newColor = getColor(newStatus);
        layer.setStyle({ fillColor: newColor });
        layer.feature.properties.Status = newStatus; // Keep props synced
      }
    });
  }
</script>
</body>
</html>
